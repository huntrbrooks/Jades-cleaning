# THIS IS AUTOGENERATED. DO NOT EDIT MANUALLY
version = 1
name = "Full Reset Cleaning"

[setup]
script = '''
set -euo pipefail

echo "Codex setup: starting"

# 1) Basic sanity checks
if [ ! -f "package.json" ]; then
  echo "No package.json found. This setup script expects a Node/Next.js project."
  exit 1
fi

# 2) Prefer pnpm, fallback to npm
PKG_MGR="npm"
if command -v pnpm >/dev/null 2>&1; then
  PKG_MGR="pnpm"
fi

echo "Using package manager: $PKG_MGR"

# 3) Install deps (cached by your machine, so this is usually quick)
if [ "$PKG_MGR" = "pnpm" ]; then
  pnpm install --frozen-lockfile || pnpm install
else
  npm ci || npm install
fi

# 4) Create env file only if missing (never overwrite secrets)
if [ ! -f ".env.local" ]; then
  if [ -f ".env.example" ]; then
    cp .env.example .env.local
    echo "Created .env.local from .env.example (fill in secrets)"
  else
    touch .env.local
    echo "Created blank .env.local (add required env vars)"
  fi
else
  echo ".env.local already exists, leaving it alone"
fi

# 5) Generate Prisma client if prisma exists (optional)
if [ -f "prisma/schema.prisma" ]; then
  echo "Prisma detected, generating client"
  if [ "$PKG_MGR" = "pnpm" ]; then
    pnpm prisma generate
  else
    npx prisma generate
  fi
fi

# 6) Quick quality gate
echo "Running typecheck/lint if available"
if [ "$PKG_MGR" = "pnpm" ]; then
  pnpm -s typecheck || true
  pnpm -s lint || true
else
  npm run -s typecheck || true
  npm run -s lint || true
fi

echo "Codex setup: done"
'''

[[actions]]
name = "Dev Server"
icon = "tool"
command = "pnpm dev || npm run dev"

[[actions]]
name = "Quality gate"
icon = "tool"
command = "pnpm lint && pnpm typecheck && pnpm test && pnpm build || (npm run lint && npm run typecheck && npm test && npm run build)"

[[actions]]
name = "Format"
icon = "tool"
command = "pnpm format || npm run format"
